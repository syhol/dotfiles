#!/usr/bin/env -S usage bash
#USAGE cmd "apply" {
#USAGE   arg "<file>"
#USAGE }
#USAGE cmd "select" {}

function apply() {

  echo "Applying $1"

  WEZTERM_THEME="$(yq '.wezterm' $1)"
  sd "color_scheme = '(.*)'" "color_scheme = '${WEZTERM_THEME}'" ~/.config/wezterm/wezterm.lua

  HELIX_THEME="$(yq '.helix' $1)"
  sd "theme = \"(.*)\"" "theme = \"${HELIX_THEME}\"" ~/.config/helix/config.toml
  pkill -USR1 hx || true

  NEOVIM_THEME="$(yq '.neovim' $1)"
  sd "colorscheme = \"(.*)\"" "colorscheme = \"${NEOVIM_THEME}\"" ~/.config/nvim/lua/plugins/colorscheme.lua

  FISH_THEME="$(yq '.fish' $1)"
  fish -c "yes | fish_config theme save '${FISH_THEME}'"

  VIVID_THEME="$(yq '.vivid' $1)"
  BAT_THEME="$(yq '.bat' $1)"
  cat >~/.config/shell/theme.sh <<EOL
# This file is autogenerated by ~/.config/themes/apply

export BAT_THEME="${BAT_THEME}"
export LS_COLORS="$(vivid generate ${VIVID_THEME})"
EOL

  mkdir -p ~/.local/state/themeset
  echo "$(basename "${1}" .yaml)" >~/.local/state/themeset/current-theme.txt

  echo "To finish applying the theme to the current shell, run the following:"
  echo "source ~/.config/shell/theme.sh"
}

function select_theme() {
  CURRENT_THEME="$(cat ~/.local/state/themeset/current-theme.txt 2>/dev/null)"

  FILES=(~/.config/themes/*.yaml)
  TOTAL=${#FILES[@]}
  I=0
  POS=0
  for FILE in "${FILES[@]}"; do
    I=$((I + 1))
    if [ "$(basename ${FILE} .yaml)" == "${CURRENT_THEME}" ]; then
      POS=$((I - TOTAL - 1))
    fi
  done

  ls ~/.config/themes/*.yaml | xargs -I{} basename {} .yaml | fzf --cycle --bind "load:pos:${POS}" --preview-window '80%,border-left' --preview '
    themeset apply ~/.config/themes/{}.yaml >/dev/null
    source ~/.config/shell/theme.sh
  
    starship prompt
    set_color $fish_color_command; echo ls; set_color normal
    ls --color always

    starship prompt
    set_color $fish_color_command; echo cat; set_color normal
    bat --color always ~/.config/shell/env.sh
  '

  echo "To finish applying the theme to the current shell, run the following:"
  echo "source ~/.config/shell/theme.sh"
}

if [ "$2" != "" ]; then
  apply "$2"
else
  select_theme
fi
