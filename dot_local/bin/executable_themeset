#!/usr/bin/env bash

function apply() {

  echo "Applying $1"

  WEZTERM_THEME="$(yq '.wezterm' $1)"
  sd "color_scheme = '(.*)'" "color_scheme = '${WEZTERM_THEME}'" ~/.config/wezterm/wezterm.lua

  HELIX_THEME="$(yq '.helix' $1)"
  sd "theme = \"(.*)\"" "theme = \"${HELIX_THEME}\"" ~/.config/helix/config.toml
  pkill -USR1 hx || true

  NEOVIM_THEME="$(yq '.neovim' $1)"
  sd "colorscheme = \"(.*)\"" "colorscheme = \"${NEOVIM_THEME}\"" ~/.config/nvim/lua/plugins/colorscheme.lua

  FISH_THEME="$(yq '.fish' $1)"
  fish -c "yes | fish_config theme save '${FISH_THEME}'"

  VIVID_THEME="$(yq '.vivid' $1)"
  BAT_THEME="$(yq '.bat' $1)"
  cat >~/.config/shell/theme.sh <<EOL
# This file is autogenerated by ~/.config/themes/apply

export BAT_THEME="${BAT_THEME}"
export LS_COLORS="$(vivid generate ${VIVID_THEME})"
EOL

  echo "To finish applying the theme to the current shell, run the following:"
  echo "source ~/.config/shell/theme.sh"
}

function select_theme() {
  ls ~/.config/themes/*.yaml | fzf --preview-window '80%,border-left' --preview '
    themeset apply {} >/dev/null
    source ~/.config/shell/theme.sh
  
    starship prompt
    set_color $fish_color_command; echo ls; set_color normal
    ls --color always

    starship prompt
    set_color $fish_color_command; echo cat; set_color normal
    bat --color always ~/.config/shell/env.sh
  '

  echo "To finish applying the theme to the current shell, run the following:"
  echo "source ~/.config/shell/theme.sh"
}

if [ "$2" != "" ]; then
  apply "$2"
else
  select_theme
fi
